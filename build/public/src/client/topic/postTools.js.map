{"version":3,"sources":["public/src/client/topic/postTools.js"],"names":["define","share","navigator","components","translator","votes","movePost","Benchpress","PostTools","staleReplyAnyway","init","tid","renderMenu","addPostHandlers","addShareHandlers","ajaxify","data","titleRaw","addVoteHandler","updatePostCount","postcount","$","on","$this","this","dropdownMenu","find","html","postEl","parents","pid","attr","index","parseInt","socket","emit","cid","err","app","alertError","message","posts","display_move_tools","parse","translate","window","trigger","toggle","isDeleted","get","toggleClass","postCount","postCountEl","utils","makeNumbersHumanReadable","setCount","postContainer","onQuoteClicked","onReplyClicked","e","preventDefault","config","relative_path","slug","body","bookmarkPost","getData","toggleVote","showVotes","require","flags","showFlagModal","type","id","btn","timestamp","postEditDuration","checkDuration","postDeleteDuration","togglePostDelete","duration","postTimestamp","languageKey","privileges","isAdminOrMod","Date","now","numDays","Math","floor","numHours","numMinutes","numSeconds","msg","purgePost","openMovePostModal","openChat","button","selectedNode","getSelectedNode","showStaleWarning","username","getUserSlug","toPid","is","text","topicName","selectedPid","quote","post","selectedText","selection","getSelection","document","createRange","postContents","content","each","el","containsNode","bounds","selectNodeContents","range","getRangeAt","cloneRange","compareBoundaryPoints","Range","START_TO_START","setStart","startContainer","startOffset","END_TO_END","setEnd","endContainer","endOffset","detach","toString","method","room_id","length","action","hasClass","postAction","bootbox","confirm","newChat","click","callback","staleThreshold","min","topicStaleDays","lastposttime","translated","warning","dialog","title","buttons","reply","label","className","create","modal"],"mappings":"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","file":"public/src/client/topic/postTools.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/postTools', [\n\t'share',\n\t'navigator',\n\t'components',\n\t'translator',\n\t'forum/topic/votes',\n\t'forum/topic/move-post',\n\t'benchpress',\n], function (share, navigator, components, translator, votes, movePost, Benchpress) {\n\tvar PostTools = {};\n\n\tvar staleReplyAnyway = false;\n\n\tPostTools.init = function (tid) {\n\t\tstaleReplyAnyway = false;\n\n\t\trenderMenu();\n\n\t\taddPostHandlers(tid);\n\n\t\tshare.addShareHandlers(ajaxify.data.titleRaw);\n\n\t\tvotes.addVoteHandler();\n\n\t\tPostTools.updatePostCount(ajaxify.data.postcount);\n\t};\n\n\tfunction renderMenu() {\n\t\t$('[component=\"topic\"]').on('show.bs.dropdown', '.moderator-tools', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar dropdownMenu = $this.find('.dropdown-menu');\n\t\t\tif (dropdownMenu.html()) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar postEl = $this.parents('[data-pid]');\n\t\t\tvar pid = postEl.attr('data-pid');\n\t\t\tvar index = parseInt(postEl.attr('data-index'), 10);\n\n\t\t\tsocket.emit('posts.loadPostTools', { pid: pid, cid: ajaxify.data.cid }, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tdata.posts.display_move_tools = data.posts.display_move_tools && index !== 0;\n\n\t\t\t\tBenchpress.parse('partials/topic/post-menu-list', data, function (html) {\n\t\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\t\tdropdownMenu.html(html);\n\t\t\t\t\t\t$(window).trigger('action:post.tools.load');\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tPostTools.toggle = function (pid, isDeleted) {\n\t\tvar postEl = components.get('post', 'pid', pid);\n\n\t\tpostEl.find('[component=\"post/quote\"], [component=\"post/bookmark\"], [component=\"post/reply\"], [component=\"post/flag\"], [component=\"user/chat\"]')\n\t\t\t.toggleClass('hidden', isDeleted);\n\n\t\tpostEl.find('[component=\"post/delete\"]').toggleClass('hidden', isDeleted);\n\t\tpostEl.find('[component=\"post/restore\"]').toggleClass('hidden', !isDeleted);\n\t\tpostEl.find('[component=\"post/purge\"]').toggleClass('hidden', !isDeleted);\n\n\t\tpostEl.find('[component=\"post/tools\"] .dropdown-menu').html('');\n\t};\n\n\tPostTools.updatePostCount = function (postCount) {\n\t\tvar postCountEl = components.get('topic/post-count');\n\t\tpostCountEl.html(postCount).attr('title', postCount);\n\t\tutils.makeNumbersHumanReadable(postCountEl);\n\t\tnavigator.setCount(postCount);\n\t};\n\n\tfunction addPostHandlers(tid) {\n\t\tvar postContainer = components.get('topic');\n\n\t\tpostContainer.on('click', '[component=\"post/quote\"]', function () {\n\t\t\tonQuoteClicked($(this), tid);\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/reply\"]', function () {\n\t\t\tonReplyClicked($(this), tid);\n\t\t});\n\n\t\t$('.topic').on('click', '[component=\"topic/reply\"]', function (e) {\n\t\t\te.preventDefault();\n\t\t\tonReplyClicked($(this), tid);\n\t\t});\n\n\t\t$('.topic').on('click', '[component=\"topic/reply-as-topic\"]', function () {\n\t\t\ttranslator.translate('[[topic:link_back, ' + ajaxify.data.titleRaw + ', ' + config.relative_path + '/topic/' + ajaxify.data.slug + ']]', function (body) {\n\t\t\t\t$(window).trigger('action:composer.topic.new', {\n\t\t\t\t\tcid: ajaxify.data.cid,\n\t\t\t\t\tbody: body,\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/bookmark\"]', function () {\n\t\t\treturn bookmarkPost($(this), getData($(this), 'data-pid'));\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/upvote\"]', function () {\n\t\t\treturn votes.toggleVote($(this), '.upvoted', 'posts.upvote');\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/downvote\"]', function () {\n\t\t\treturn votes.toggleVote($(this), '.downvoted', 'posts.downvote');\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/vote-count\"]', function () {\n\t\t\tvotes.showVotes(getData($(this), 'data-pid'));\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/flag\"]', function () {\n\t\t\tvar pid = getData($(this), 'data-pid');\n\t\t\trequire(['flags'], function (flags) {\n\t\t\t\tflags.showFlagModal({\n\t\t\t\t\ttype: 'post',\n\t\t\t\t\tid: pid,\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/edit\"]', function () {\n\t\t\tvar btn = $(this);\n\n\t\t\tvar timestamp = parseInt(getData(btn, 'data-timestamp'), 10);\n\t\t\tvar postEditDuration = parseInt(ajaxify.data.postEditDuration, 10);\n\n\t\t\tif (checkDuration(postEditDuration, timestamp, 'post-edit-duration-expired')) {\n\t\t\t\t$(window).trigger('action:composer.post.edit', {\n\t\t\t\t\tpid: getData(btn, 'data-pid'),\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/delete\"]', function () {\n\t\t\tvar btn = $(this);\n\t\t\tvar timestamp = parseInt(getData(btn, 'data-timestamp'), 10);\n\t\t\tvar postDeleteDuration = parseInt(ajaxify.data.postDeleteDuration, 10);\n\t\t\tif (checkDuration(postDeleteDuration, timestamp, 'post-delete-duration-expired')) {\n\t\t\t\ttogglePostDelete($(this), tid);\n\t\t\t}\n\t\t});\n\n\t\tfunction checkDuration(duration, postTimestamp, languageKey) {\n\t\t\tif (!ajaxify.data.privileges.isAdminOrMod && duration && Date.now() - postTimestamp > duration * 1000) {\n\t\t\t\tvar numDays = Math.floor(duration / 86400);\n\t\t\t\tvar numHours = Math.floor((duration % 86400) / 3600);\n\t\t\t\tvar numMinutes = Math.floor(((duration % 86400) % 3600) / 60);\n\t\t\t\tvar numSeconds = ((duration % 86400) % 3600) % 60;\n\t\t\t\tvar msg = '[[error:' + languageKey + ', ' + duration + ']]';\n\t\t\t\tif (numDays) {\n\t\t\t\t\tif (numHours) {\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-days-hours, ' + numDays + ', ' + numHours + ']]';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-days, ' + numDays + ']]';\n\t\t\t\t\t}\n\t\t\t\t} else if (numHours) {\n\t\t\t\t\tif (numMinutes) {\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-hours-minutes, ' + numHours + ', ' + numMinutes + ']]';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-hours, ' + numHours + ']]';\n\t\t\t\t\t}\n\t\t\t\t} else if (numMinutes) {\n\t\t\t\t\tif (numSeconds) {\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-minutes-seconds, ' + numMinutes + ', ' + numSeconds + ']]';\n\t\t\t\t\t} else {\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-minutes, ' + numMinutes + ']]';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tapp.alertError(msg);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t}\n\n\t\tpostContainer.on('click', '[component=\"post/restore\"]', function () {\n\t\t\ttogglePostDelete($(this), tid);\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/purge\"]', function () {\n\t\t\tpurgePost($(this), tid);\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/move\"]', function () {\n\t\t\tmovePost.openMovePostModal($(this));\n\t\t});\n\n\t\tpostContainer.on('click', '[component=\"post/chat\"]', function () {\n\t\t\topenChat($(this));\n\t\t});\n\t}\n\n\tfunction onReplyClicked(button, tid) {\n\t\tvar selectedNode = getSelectedNode();\n\n\t\tshowStaleWarning(function () {\n\t\t\tvar username = getUserSlug(button);\n\t\t\tif (getData(button, 'data-uid') === '0' || !getData(button, 'data-userslug')) {\n\t\t\t\tusername = '';\n\t\t\t}\n\n\t\t\tvar toPid = button.is('[component=\"post/reply\"]') ? getData(button, 'data-pid') : null;\n\n\t\t\tif (selectedNode.text && (!toPid || !selectedNode.pid || toPid === selectedNode.pid)) {\n\t\t\t\tusername = username || selectedNode.username;\n\t\t\t\t$(window).trigger('action:composer.addQuote', {\n\t\t\t\t\ttid: tid,\n\t\t\t\t\tpid: toPid,\n\t\t\t\t\ttopicName: ajaxify.data.titleRaw,\n\t\t\t\t\tusername: username,\n\t\t\t\t\ttext: selectedNode.text,\n\t\t\t\t\tselectedPid: selectedNode.pid,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\t$(window).trigger('action:composer.post.new', {\n\t\t\t\t\ttid: tid,\n\t\t\t\t\tpid: toPid,\n\t\t\t\t\ttopicName: ajaxify.data.titleRaw,\n\t\t\t\t\ttext: username ? username + ' ' : '',\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction onQuoteClicked(button, tid) {\n\t\tvar selectedNode = getSelectedNode();\n\n\t\tshowStaleWarning(function () {\n\t\t\tvar username = getUserSlug(button);\n\t\t\tvar toPid = getData(button, 'data-pid');\n\n\t\t\tfunction quote(text) {\n\t\t\t\t$(window).trigger('action:composer.addQuote', {\n\t\t\t\t\ttid: tid,\n\t\t\t\t\tpid: toPid,\n\t\t\t\t\tusername: username,\n\t\t\t\t\ttopicName: ajaxify.data.titleRaw,\n\t\t\t\t\ttext: text,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (selectedNode.text && toPid && toPid === selectedNode.pid) {\n\t\t\t\treturn quote(selectedNode.text);\n\t\t\t}\n\t\t\tsocket.emit('posts.getRawPost', toPid, function (err, post) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\n\t\t\t\tquote(post);\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction getSelectedNode() {\n\t\tvar selectedText = '';\n\t\tvar selectedPid;\n\t\tvar username = '';\n\t\tvar selection = window.getSelection ? window.getSelection() : document.selection.createRange();\n\t\tvar postContents = $('[component=\"post\"] [component=\"post/content\"]');\n\t\tvar content;\n\t\tpostContents.each(function (index, el) {\n\t\t\tif (selection && selection.containsNode && el && selection.containsNode(el, true)) {\n\t\t\t\tcontent = el;\n\t\t\t}\n\t\t});\n\n\t\tif (content) {\n\t\t\tvar bounds = document.createRange();\n\t\t\tbounds.selectNodeContents(content);\n\t\t\tvar range = selection.getRangeAt(0).cloneRange();\n\t\t\tif (range.compareBoundaryPoints(Range.START_TO_START, bounds) < 0) {\n\t\t\t\trange.setStart(bounds.startContainer, bounds.startOffset);\n\t\t\t}\n\t\t\tif (range.compareBoundaryPoints(Range.END_TO_END, bounds) > 0) {\n\t\t\t\trange.setEnd(bounds.endContainer, bounds.endOffset);\n\t\t\t}\n\t\t\tbounds.detach();\n\t\t\tselectedText = range.toString();\n\t\t\tvar postEl = $(content).parents('[component=\"post\"]');\n\t\t\tselectedPid = postEl.attr('data-pid');\n\t\t\tusername = getUserSlug($(content));\n\t\t\trange.detach();\n\t\t}\n\t\treturn { text: selectedText, pid: selectedPid, username: username };\n\t}\n\n\tfunction bookmarkPost(button, pid) {\n\t\tvar method = button.attr('data-bookmarked') === 'false' ? 'posts.bookmark' : 'posts.unbookmark';\n\n\t\tsocket.emit(method, {\n\t\t\tpid: pid,\n\t\t\troom_id: 'topic_' + ajaxify.data.tid,\n\t\t}, function (err) {\n\t\t\tif (err) {\n\t\t\t\tapp.alertError(err.message);\n\t\t\t}\n\t\t});\n\n\t\treturn false;\n\t}\n\n\tfunction getData(button, data) {\n\t\treturn button.parents('[data-pid]').attr(data);\n\t}\n\n\tfunction getUserSlug(button) {\n\t\tvar slug = '';\n\t\tvar post = button.parents('[data-pid]');\n\n\t\tif (button.attr('component') === 'topic/reply') {\n\t\t\treturn slug;\n\t\t}\n\n\t\tif (post.length) {\n\t\t\tslug = post.attr('data-userslug');\n\t\t}\n\t\tif (post.length && post.attr('data-uid') !== '0') {\n\t\t\tslug = '@' + slug;\n\t\t}\n\n\t\treturn slug;\n\t}\n\n\tfunction togglePostDelete(button, tid) {\n\t\tvar pid = getData(button, 'data-pid');\n\t\tvar postEl = components.get('post', 'pid', pid);\n\t\tvar action = !postEl.hasClass('deleted') ? 'delete' : 'restore';\n\n\t\tpostAction(action, pid, tid);\n\t}\n\n\tfunction purgePost(button, tid) {\n\t\tpostAction('purge', getData(button, 'data-pid'), tid);\n\t}\n\n\tfunction postAction(action, pid, tid) {\n\t\ttranslator.translate('[[topic:post_' + action + '_confirm]]', function (msg) {\n\t\t\tbootbox.confirm(msg, function (confirm) {\n\t\t\t\tif (!confirm) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsocket.emit('posts.' + action, {\n\t\t\t\t\tpid: pid,\n\t\t\t\t\ttid: tid,\n\t\t\t\t}, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction openChat(button) {\n\t\tvar post = button.parents('[data-pid]');\n\n\t\tapp.newChat(post.attr('data-uid'));\n\t\tbutton.parents('.btn-group').find('.dropdown-toggle').click();\n\t\treturn false;\n\t}\n\n\tfunction showStaleWarning(callback) {\n\t\tvar staleThreshold = Math.min(Date.now() - (1000 * 60 * 60 * 24 * ajaxify.data.topicStaleDays), 8640000000000000);\n\t\tif (staleReplyAnyway || ajaxify.data.lastposttime >= staleThreshold) {\n\t\t\treturn callback();\n\t\t}\n\n\t\ttranslator.translate('[[topic:stale.warning]]', function (translated) {\n\t\t\tvar warning = bootbox.dialog({\n\t\t\t\ttitle: '[[topic:stale.title]]',\n\t\t\t\tmessage: translated,\n\t\t\t\tbuttons: {\n\t\t\t\t\treply: {\n\t\t\t\t\t\tlabel: '[[topic:stale.reply_anyway]]',\n\t\t\t\t\t\tclassName: 'btn-link',\n\t\t\t\t\t\tcallback: function () {\n\t\t\t\t\t\t\tstaleReplyAnyway = true;\n\t\t\t\t\t\t\tcallback();\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tcreate: {\n\t\t\t\t\t\tlabel: '[[topic:stale.create]]',\n\t\t\t\t\t\tclassName: 'btn-primary',\n\t\t\t\t\t\tcallback: function () {\n\t\t\t\t\t\t\ttranslator.translate('[[topic:link_back, ' + ajaxify.data.title + ', ' + config.relative_path + '/topic/' + ajaxify.data.slug + ']]', function (body) {\n\t\t\t\t\t\t\t\t$(window).trigger('action:composer.topic.new', {\n\t\t\t\t\t\t\t\t\tcid: ajaxify.data.cid,\n\t\t\t\t\t\t\t\t\tbody: body,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\twarning.modal();\n\t\t});\n\t}\n\n\treturn PostTools;\n});\n"]}