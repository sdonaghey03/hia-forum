{"version":3,"sources":["public/src/client/topic/threadTools.js"],"names":["define","fork","move","deletePosts","components","translator","Benchpress","ThreadTools","init","tid","renderMenu","topicContainer","$","on","topicCommand","socket","emit","tids","cid","ajaxify","data","err","app","alertError","alertSuccess","btn","this","message","parents","find","trigger","changeWatching","type","alert","alert_id","title","timeout","setFollowState","window","$this","dropdownMenu","html","parse","translate","command","msg","bootbox","confirm","setLockedState","threadEl","get","parseInt","attr","isLocked","privileges","isAdminOrMod","toggleClass","hideReply","deleted","user","uid","locked","setDeleteState","isDelete","setPinnedState","isPinned","pinned","state","menu"],"mappings":"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","file":"public/src/client/topic/threadTools.js","sourcesContent":["'use strict';\n\n\ndefine('forum/topic/threadTools', [\n\t'forum/topic/fork',\n\t'forum/topic/move',\n\t'forum/topic/delete-posts',\n\t'components',\n\t'translator',\n\t'benchpress',\n], function (fork, move, deletePosts, components, translator, Benchpress) {\n\tvar ThreadTools = {};\n\n\tThreadTools.init = function (tid) {\n\t\trenderMenu();\n\n\t\tvar topicContainer = $('.topic');\n\n\t\ttopicContainer.on('click', '[component=\"topic/delete\"]', function () {\n\t\t\ttopicCommand('delete', tid);\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/restore\"]', function () {\n\t\t\ttopicCommand('restore', tid);\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/purge\"]', function () {\n\t\t\ttopicCommand('purge', tid);\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/lock\"]', function () {\n\t\t\tsocket.emit('topics.lock', { tids: [tid], cid: ajaxify.data.cid });\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/unlock\"]', function () {\n\t\t\tsocket.emit('topics.unlock', { tids: [tid], cid: ajaxify.data.cid });\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/pin\"]', function () {\n\t\t\tsocket.emit('topics.pin', { tids: [tid], cid: ajaxify.data.cid });\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/unpin\"]', function () {\n\t\t\tsocket.emit('topics.unpin', { tids: [tid], cid: ajaxify.data.cid });\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/mark-unread\"]', function () {\n\t\t\tsocket.emit('topics.markUnread', tid, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\t\t\t\tapp.alertSuccess('[[topic:mark_unread.success]]');\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/mark-unread-for-all\"]', function () {\n\t\t\tvar btn = $(this);\n\t\t\tsocket.emit('topics.markAsUnreadForAll', [tid], function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tapp.alertSuccess('[[topic:markAsUnreadForAll.success]]');\n\t\t\t\tbtn.parents('.thread-tools.open').find('.dropdown-toggle').trigger('click');\n\t\t\t});\n\t\t\treturn false;\n\t\t});\n\n\t\ttopicContainer.on('click', '[component=\"topic/move\"]', function () {\n\t\t\tmove.init([tid], ajaxify.data.cid);\n\t\t\treturn false;\n\t\t});\n\n\t\tdeletePosts.init();\n\t\tfork.init();\n\n\t\t$('.topic').on('click', '[component=\"topic/following\"]', function () {\n\t\t\tchangeWatching('follow');\n\t\t});\n\t\t$('.topic').on('click', '[component=\"topic/not-following\"]', function () {\n\t\t\tchangeWatching('unfollow');\n\t\t});\n\t\t$('.topic').on('click', '[component=\"topic/ignoring\"]', function () {\n\t\t\tchangeWatching('ignore');\n\t\t});\n\n\t\tfunction changeWatching(type) {\n\t\t\tsocket.emit('topics.changeWatching', { tid: tid, type: type }, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alert({\n\t\t\t\t\t\ttype: 'danger',\n\t\t\t\t\t\talert_id: 'topic_follow',\n\t\t\t\t\t\ttitle: '[[global:please_log_in]]',\n\t\t\t\t\t\tmessage: '[[topic:login_to_subscribe]]',\n\t\t\t\t\t\ttimeout: 5000,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tvar message = '';\n\t\t\t\tif (type === 'follow') {\n\t\t\t\t\tmessage = '[[topic:following_topic.message]]';\n\t\t\t\t} else if (type === 'unfollow') {\n\t\t\t\t\tmessage = '[[topic:not_following_topic.message]]';\n\t\t\t\t} else if (type === 'ignore') {\n\t\t\t\t\tmessage = '[[topic:ignoring_topic.message]]';\n\t\t\t\t}\n\t\t\t\tsetFollowState(type);\n\n\t\t\t\tapp.alert({\n\t\t\t\t\talert_id: 'follow_thread',\n\t\t\t\t\tmessage: message,\n\t\t\t\t\ttype: 'success',\n\t\t\t\t\ttimeout: 5000,\n\t\t\t\t});\n\n\t\t\t\t$(window).trigger('action:topics.changeWatching', { tid: tid, type: type });\n\t\t\t});\n\n\t\t\treturn false;\n\t\t}\n\t};\n\n\tfunction renderMenu() {\n\t\t$('.topic').on('show.bs.dropdown', '.thread-tools', function () {\n\t\t\tvar $this = $(this);\n\t\t\tvar dropdownMenu = $this.find('.dropdown-menu');\n\t\t\tif (dropdownMenu.html()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tsocket.emit('topics.loadTopicTools', { tid: ajaxify.data.tid, cid: ajaxify.data.cid }, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err);\n\t\t\t\t}\n\n\t\t\t\tBenchpress.parse('partials/topic/topic-menu-list', data, function (html) {\n\t\t\t\t\ttranslator.translate(html, function (html) {\n\t\t\t\t\t\tdropdownMenu.html(html);\n\t\t\t\t\t\t$(window).trigger('action:topic.tools.load');\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction topicCommand(command, tid) {\n\t\ttranslator.translate('[[topic:thread_tools.' + command + '_confirm]]', function (msg) {\n\t\t\tbootbox.confirm(msg, function (confirm) {\n\t\t\t\tif (!confirm) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tsocket.emit('topics.' + command, { tids: [tid], cid: ajaxify.data.cid }, function (err) {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tThreadTools.setLockedState = function (data) {\n\t\tvar threadEl = components.get('topic');\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar isLocked = data.isLocked && !ajaxify.data.privileges.isAdminOrMod;\n\n\t\tcomponents.get('topic/lock').toggleClass('hidden', data.isLocked);\n\t\tcomponents.get('topic/unlock').toggleClass('hidden', !data.isLocked);\n\n\t\tvar hideReply = (data.isLocked || ajaxify.data.deleted) && !ajaxify.data.privileges.isAdminOrMod;\n\n\t\tcomponents.get('topic/reply/container').toggleClass('hidden', hideReply);\n\t\tcomponents.get('topic/reply/locked').toggleClass('hidden', ajaxify.data.privileges.isAdminOrMod || !data.isLocked || ajaxify.data.deleted);\n\n\t\tthreadEl.find('[component=\"post\"]:not(.deleted) [component=\"post/reply\"], [component=\"post\"]:not(.deleted) [component=\"post/quote\"]').toggleClass('hidden', hideReply);\n\t\tthreadEl.find('[component=\"post/edit\"], [component=\"post/delete\"]').toggleClass('hidden', isLocked);\n\n\t\tthreadEl.find('[component=\"post\"][data-uid=\"' + app.user.uid + '\"].deleted [component=\"post/tools\"]').toggleClass('hidden', isLocked);\n\n\t\t$('[component=\"post/header\"] i.fa-lock').toggleClass('hidden', !data.isLocked);\n\t\t$('[component=\"post/tools\"] .dropdown-menu').html('');\n\t\tajaxify.data.locked = data.isLocked;\n\t};\n\n\tThreadTools.setDeleteState = function (data) {\n\t\tvar threadEl = components.get('topic');\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tcomponents.get('topic/delete').toggleClass('hidden', data.isDelete);\n\t\tcomponents.get('topic/restore').toggleClass('hidden', !data.isDelete);\n\t\tcomponents.get('topic/purge').toggleClass('hidden', !data.isDelete);\n\t\tcomponents.get('topic/deleted/message').toggleClass('hidden', !data.isDelete);\n\n\t\tvar hideReply = data.isDelete && !ajaxify.data.privileges.isAdminOrMod;\n\n\t\tcomponents.get('topic/reply/container').toggleClass('hidden', hideReply);\n\t\tcomponents.get('topic/reply/locked').toggleClass('hidden', ajaxify.data.privileges.isAdminOrMod || !ajaxify.data.locked || data.isDelete);\n\t\tthreadEl.find('[component=\"post\"]:not(.deleted) [component=\"post/reply\"], [component=\"post\"]:not(.deleted) [component=\"post/quote\"]').toggleClass('hidden', hideReply);\n\n\t\tthreadEl.toggleClass('deleted', data.isDelete);\n\t\tajaxify.data.deleted = data.isDelete;\n\t};\n\n\n\tThreadTools.setPinnedState = function (data) {\n\t\tvar threadEl = components.get('topic');\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\n\t\t\treturn;\n\t\t}\n\n\t\tcomponents.get('topic/pin').toggleClass('hidden', data.isPinned);\n\t\tcomponents.get('topic/unpin').toggleClass('hidden', !data.isPinned);\n\t\t$('[component=\"post/header\"] i.fa-thumb-tack').toggleClass('hidden', !data.isPinned);\n\t\tajaxify.data.pinned = data.isPinned;\n\t};\n\n\tfunction setFollowState(state) {\n\t\tvar menu = components.get('topic/following/menu');\n\t\tmenu.toggleClass('hidden', state !== 'follow');\n\t\tcomponents.get('topic/following/check').toggleClass('fa-check', state === 'follow');\n\n\t\tmenu = components.get('topic/not-following/menu');\n\t\tmenu.toggleClass('hidden', state !== 'unfollow');\n\t\tcomponents.get('topic/not-following/check').toggleClass('fa-check', state === 'unfollow');\n\n\t\tmenu = components.get('topic/ignoring/menu');\n\t\tmenu.toggleClass('hidden', state !== 'ignore');\n\t\tcomponents.get('topic/ignoring/check').toggleClass('fa-check', state === 'ignore');\n\t}\n\n\n\treturn ThreadTools;\n});\n"]}