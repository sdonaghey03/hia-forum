{"version":3,"sources":["public/src/modules/pictureCropper.js"],"names":["define","translator","Cropper","Benchpress","module","show","data","callback","fileSize","hasOwnProperty","undefined","parseInt","parseModal","showHelp","title","description","button","accept","replace","uploadModal","$","modal","on","remove","find","this","addClass","onSubmit","handleImageCrop","parse","url","cropperHtml","translate","translated","cropperModal","backdrop","cropBoxHeight","window","height","img","document","getElementById","css","cropperTool","aspectRatio","autoCropArea","viewMode","cropmove","restrictImageDimension","cropBoxData","width","imageDimension","setCropBoxData","ready","origDimension","dimension","degrees","getAttribute","rotate","option","method","scaleX","scaleY","setAttribute","reset","imageData","imageType","getCroppedCanvas","toDataURL","removeClass","socketData","paramName","paramValue","socket","emit","socketMethod","err","hide","app","alertError","message","destroy","trigger","showAlert","type","hideAlerts","translateText","fileInput","val","file","files","reader","FileReader","imageUrl","addEventListener","result","allowSkippingCrop","readAsDataURL","tplVals","html"],"mappings":"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","file":"public/src/modules/pictureCropper.js","sourcesContent":["'use strict';\n\n\ndefine('pictureCropper', ['translator', 'cropper', 'benchpress'], function (translator, Cropper, Benchpress) {\n\tvar module = {};\n\n\tmodule.show = function (data, callback) {\n\t\tvar fileSize = data.hasOwnProperty('fileSize') && data.fileSize !== undefined ? parseInt(data.fileSize, 10) : false;\n\t\tparseModal({\n\t\t\tshowHelp: data.hasOwnProperty('showHelp') && data.showHelp !== undefined ? data.showHelp : true,\n\t\t\tfileSize: fileSize,\n\t\t\ttitle: data.title || '[[global:upload_file]]',\n\t\t\tdescription: data.description || '',\n\t\t\tbutton: data.button || '[[global:upload]]',\n\t\t\taccept: data.accept ? data.accept.replace(/,/g, '&#44; ') : '',\n\t\t}, function (uploadModal) {\n\t\t\tuploadModal = $(uploadModal);\n\n\t\t\tuploadModal.modal('show');\n\t\t\tuploadModal.on('hidden.bs.modal', function () {\n\t\t\t\tuploadModal.remove();\n\t\t\t});\n\n\t\t\tuploadModal.find('#fileUploadSubmitBtn').on('click', function () {\n\t\t\t\t$(this).addClass('disabled');\n\t\t\t\tdata.uploadModal = uploadModal;\n\t\t\t\tonSubmit(data, callback);\n\t\t\t\treturn false;\n\t\t\t});\n\t\t});\n\t};\n\n\tmodule.handleImageCrop = function (data, callback) {\n\t\t$('#crop-picture-modal').remove();\n\t\tBenchpress.parse('modals/crop_picture', {\n\t\t\turl: data.url,\n\t\t}, function (cropperHtml) {\n\t\t\ttranslator.translate(cropperHtml, function (translated) {\n\t\t\t\tvar cropperModal = $(translated);\n\t\t\t\tcropperModal.modal({\n\t\t\t\t\tbackdrop: 'static',\n\t\t\t\t}).modal('show');\n\n\t\t\t\t// Set cropper image max-height based on viewport\n\t\t\t\tvar cropBoxHeight = parseInt($(window).height() / 2, 10);\n\t\t\t\tvar img = document.getElementById('cropped-image');\n\t\t\t\t$(img).css('max-height', cropBoxHeight);\n\n\t\t\t\tvar cropperTool = new Cropper(img, {\n\t\t\t\t\taspectRatio: data.aspectRatio,\n\t\t\t\t\tautoCropArea: 1,\n\t\t\t\t\tviewMode: 1,\n\t\t\t\t\tcropmove: function () {\n\t\t\t\t\t\tif (data.restrictImageDimension) {\n\t\t\t\t\t\t\tif (cropperTool.cropBoxData.width > data.imageDimension) {\n\t\t\t\t\t\t\t\tcropperTool.setCropBoxData({\n\t\t\t\t\t\t\t\t\twidth: data.imageDimension,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (cropperTool.cropBoxData.height > data.imageDimension) {\n\t\t\t\t\t\t\t\tcropperTool.setCropBoxData({\n\t\t\t\t\t\t\t\t\theight: data.imageDimension,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tready: function () {\n\t\t\t\t\t\tif (data.restrictImageDimension) {\n\t\t\t\t\t\t\tvar origDimension = (img.width < img.height) ? img.width : img.height;\n\t\t\t\t\t\t\tvar dimension = (origDimension > data.imageDimension) ? data.imageDimension : origDimension;\n\t\t\t\t\t\t\tcropperTool.setCropBoxData({\n\t\t\t\t\t\t\t\twidth: dimension,\n\t\t\t\t\t\t\t\theight: dimension,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tcropperModal.find('.rotate').on('click', function () {\n\t\t\t\t\t\t\tvar degrees = this.getAttribute('data-degrees');\n\t\t\t\t\t\t\tcropperTool.rotate(degrees);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tcropperModal.find('.flip').on('click', function () {\n\t\t\t\t\t\t\tvar option = this.getAttribute('data-option');\n\t\t\t\t\t\t\tvar method = this.getAttribute('data-method');\n\t\t\t\t\t\t\tif (method === 'scaleX') {\n\t\t\t\t\t\t\t\tcropperTool.scaleX(option);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tcropperTool.scaleY(option);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tthis.setAttribute('data-option', option * -1);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tcropperModal.find('.reset').on('click', function () {\n\t\t\t\t\t\t\tcropperTool.reset();\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tcropperModal.find('.crop-btn').on('click', function () {\n\t\t\t\t\t\t\t$(this).addClass('disabled');\n\t\t\t\t\t\t\tvar imageData = data.imageType ? cropperTool.getCroppedCanvas().toDataURL(data.imageType) : cropperTool.getCroppedCanvas().toDataURL();\n\n\t\t\t\t\t\t\tcropperModal.find('#upload-progress-bar').css('width', '100%');\n\t\t\t\t\t\t\tcropperModal.find('#upload-progress-box').show().removeClass('hide');\n\n\t\t\t\t\t\t\tvar socketData = {};\n\t\t\t\t\t\t\tsocketData[data.paramName] = data.paramValue;\n\t\t\t\t\t\t\tsocketData.imageData = imageData;\n\n\t\t\t\t\t\t\tsocket.emit(data.socketMethod, socketData, function (err, imageData) {\n\t\t\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\t\t\tcropperModal.find('#upload-progress-box').hide();\n\t\t\t\t\t\t\t\t\tcropperModal.find('.upload-btn').removeClass('disabled');\n\t\t\t\t\t\t\t\t\tcropperModal.find('.crop-btn').removeClass('disabled');\n\t\t\t\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tcallback(imageData.url);\n\t\t\t\t\t\t\t\tcropperModal.modal('hide');\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tcropperModal.find('.upload-btn').on('click', function () {\n\t\t\t\t\t\t\t$(this).addClass('disabled');\n\t\t\t\t\t\t\tcropperTool.destroy();\n\n\t\t\t\t\t\t\tcropperTool = new Cropper(img, {\n\t\t\t\t\t\t\t\tviewMode: 1,\n\t\t\t\t\t\t\t\tautoCropArea: 1,\n\t\t\t\t\t\t\t\tready: function () {\n\t\t\t\t\t\t\t\t\tcropperModal.find('.crop-btn').trigger('click');\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tfunction onSubmit(data, callback) {\n\t\tfunction showAlert(type, message) {\n\t\t\tmodule.hideAlerts(data.uploadModal);\n\t\t\tif (type === 'error') {\n\t\t\t\tdata.uploadModal.find('#fileUploadSubmitBtn').removeClass('disabled');\n\t\t\t}\n\t\t\tdata.uploadModal.find('#alert-' + type).translateText(message).removeClass('hide');\n\t\t}\n\n\t\tvar fileInput = data.uploadModal.find('#fileInput');\n\t\tif (!fileInput.val()) {\n\t\t\treturn showAlert('error', '[[uploads:select-file-to-upload]]');\n\t\t}\n\n\t\tvar file = fileInput[0].files[0];\n\t\tvar reader = new FileReader();\n\t\tvar imageUrl;\n\t\tvar imageType = file.type;\n\n\t\treader.addEventListener('load', function () {\n\t\t\timageUrl = reader.result;\n\n\t\t\tdata.uploadModal.modal('hide');\n\n\t\t\tmodule.handleImageCrop({\n\t\t\t\turl: imageUrl,\n\t\t\t\timageType: imageType,\n\t\t\t\tsocketMethod: data.socketMethod,\n\t\t\t\taspectRatio: data.aspectRatio,\n\t\t\t\tallowSkippingCrop: data.allowSkippingCrop,\n\t\t\t\trestrictImageDimension: data.restrictImageDimension,\n\t\t\t\timageDimension: data.imageDimension,\n\t\t\t\tparamName: data.paramName,\n\t\t\t\tparamValue: data.paramValue,\n\t\t\t}, callback);\n\t\t}, false);\n\n\t\tif (file) {\n\t\t\treader.readAsDataURL(file);\n\t\t}\n\t}\n\n\tfunction parseModal(tplVals, callback) {\n\t\tBenchpress.parse('partials/modals/upload_file_modal', tplVals, function (html) {\n\t\t\ttranslator.translate(html, callback);\n\t\t});\n\t}\n\n\treturn module;\n});\n"]}