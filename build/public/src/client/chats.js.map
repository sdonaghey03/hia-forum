{"version":3,"sources":["public/src/client/chats.js"],"names":["define","components","translator","mousetrap","recentChats","search","messages","Benchpress","Chats","initialised","newMessage","init","env","utils","findBootstrapEnvironment","addSocketListeners","addGlobalEventListeners","addEventListeners","createTagsInput","$","ajaxify","data","createAutoComplete","get","on","toggleClass","resizeMainWindow","addHotkeys","scrollToBottom","hasOwnProperty","focus","addSendHandlers","roomId","text","val","app","previousUrl","match","go","userslug","openChat","uid","window","history","one","addEditDeleteHandler","addRenameHandler","addScrollHandler","addCharactersLeftHandler","el","loading","off","top","scrollHeight","height","scrollTop","start","parseInt","children","first","attr","socket","emit","err","alertError","message","parseMessage","html","currentScrollTop","previousHeight","prepend","find","timeago","addClass","element","length","messageId","this","parents","inputEl","prepEdit","delete","bind","activeContact","prev","switchChat","next","e","target","last","lastMid","oldName","ev","type","keyCode","newName","blur","sendEl","which","shiftKey","sendMessage","strategies","options","zIndex","listPosition","position","$el","css","_applyPlacement","trigger","textcomplete","tagEl","tagsinput","confirmKeys","trimValue","users","forEach","user","username","event","cancel","item","nouser","isOwner","owner","input","require","autocomplete","leave","remove","chat","modal","getModal","close","roomid","url","self","fetch","config","relative_path","credentials","then","response","ok","json","payload","parseAndTranslate","setActive","pushState","location","protocol","host","console","warn","status","catch","error","appendChatMessage","currentPage","startsWith","roomEl","recentEl","parse","rooms","lastUser","fromUser","usernames","unread","translate","translated","updateUserStatus","onChatMessageEdit","messagesList","searchHeight","searchListHeight","outerHeight","fromTop","offset","margin","inputHeight","removeClass"],"mappings":"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","file":"public/src/client/chats.js","sourcesContent":["'use strict';\n\n\ndefine('forum/chats', [\n\t'components',\n\t'translator',\n\t'mousetrap',\n\t'forum/chats/recent',\n\t'forum/chats/search',\n\t'forum/chats/messages',\n\t'benchpress',\n], function (components, translator, mousetrap, recentChats, search, messages, Benchpress) {\n\tvar Chats = {\n\t\tinitialised: false,\n\t};\n\n\tvar newMessage = false;\n\n\tChats.init = function () {\n\t\tvar env = utils.findBootstrapEnvironment();\n\n\t\tif (!Chats.initialised) {\n\t\t\tChats.addSocketListeners();\n\t\t\tChats.addGlobalEventListeners();\n\t\t}\n\n\t\trecentChats.init();\n\n\t\tChats.addEventListeners();\n\t\tChats.createTagsInput($('[component=\"chat/messages\"] .users-tag-input'), ajaxify.data);\n\t\tChats.createAutoComplete($('[component=\"chat/input\"]'));\n\n\t\tcomponents.get('expanded-chat/controlsToggle').on('click', function () {\n\t\t\tcomponents.get('expanded-chat/controls').toggleClass('hide');\n\t\t});\n\n\t\tif (env === 'md' || env === 'lg') {\n\t\t\tChats.resizeMainWindow();\n\t\t\tChats.addHotkeys();\n\t\t}\n\n\t\tmessages.scrollToBottom($('.expanded-chat ul'));\n\n\t\tChats.initialised = true;\n\n\t\tsearch.init();\n\n\t\tif (ajaxify.data.hasOwnProperty('roomId')) {\n\t\t\tcomponents.get('chat/input').focus();\n\t\t}\n\t};\n\n\tChats.addEventListeners = function () {\n\t\tChats.addSendHandlers(ajaxify.data.roomId, $('.chat-input'), $('.expanded-chat button[data-action=\"send\"]'));\n\n\t\t$('[data-action=\"pop-out\"]').on('click', function () {\n\t\t\tvar text = components.get('chat/input').val();\n\t\t\tvar roomId = ajaxify.data.roomId;\n\n\t\t\tif (app.previousUrl && app.previousUrl.match(/chats/)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats', function () {\n\t\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t\t}, true);\n\t\t\t} else {\n\t\t\t\twindow.history.go(-1);\n\t\t\t\tapp.openChat(roomId, ajaxify.data.uid);\n\t\t\t}\n\n\t\t\t$(window).one('action:chat.loaded', function () {\n\t\t\t\tcomponents.get('chat/input').val(text);\n\t\t\t});\n\t\t});\n\n\t\tChats.addEditDeleteHandler(components.get('chat/messages'), ajaxify.data.roomId);\n\n\t\tChats.addRenameHandler(ajaxify.data.roomId, $('[component=\"chat/room/name\"]'));\n\t\tChats.addScrollHandler(ajaxify.data.roomId, ajaxify.data.uid, $('.chat-content'));\n\t\tChats.addCharactersLeftHandler(components.get('chat/input'));\n\t};\n\n\tChats.addScrollHandler = function (roomId, uid, el) {\n\t\tvar loading = false;\n\t\tel.off('scroll').on('scroll', function () {\n\t\t\tif (loading) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar top = (el[0].scrollHeight - el.height()) * 0.1;\n\t\t\tif (el.scrollTop() >= top) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tloading = true;\n\t\t\tvar start = parseInt($('.chat-content').children('[data-index]').first().attr('data-index'), 10) + 1;\n\t\t\tsocket.emit('modules.chats.getMessages', {\n\t\t\t\troomId: roomId,\n\t\t\t\tuid: uid,\n\t\t\t\tstart: start,\n\t\t\t}, function (err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (!data) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tmessages.parseMessage(data, function (html) {\n\t\t\t\t\tvar currentScrollTop = el.scrollTop();\n\t\t\t\t\tvar previousHeight = el[0].scrollHeight;\n\t\t\t\t\thtml = $(html);\n\t\t\t\t\tel.prepend(html);\n\t\t\t\t\thtml.find('.timeago').timeago();\n\t\t\t\t\thtml.find('img:not(.not-responsive)').addClass('img-responsive');\n\t\t\t\t\tel.scrollTop((el[0].scrollHeight - previousHeight) + currentScrollTop);\n\t\t\t\t\tloading = false;\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addCharactersLeftHandler = function (element) {\n\t\telement.on('keyup', function () {\n\t\t\t$('[component=\"chat/message/length\"]').text(element.val().length);\n\t\t});\n\t};\n\n\tChats.addEditDeleteHandler = function (element, roomId) {\n\t\telement.on('click', '[data-action=\"edit\"]', function () {\n\t\t\tvar messageId = $(this).parents('[data-mid]').attr('data-mid');\n\t\t\tvar inputEl = $('[data-roomid=\"' + roomId + '\"] [component=\"chat/input\"]');\n\t\t\tmessages.prepEdit(inputEl, messageId, roomId);\n\t\t}).on('click', '[data-action=\"delete\"]', function () {\n\t\t\tvar messageId = $(this).parents('[data-mid]').attr('data-mid');\n\t\t\tmessages.delete(messageId, roomId);\n\t\t});\n\t};\n\n\tChats.addHotkeys = function () {\n\t\tmousetrap.bind('ctrl+up', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-primary');\n\t\t\tvar prev = activeContact.prev();\n\n\t\t\tif (prev.length) {\n\t\t\t\tChats.switchChat(prev.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('ctrl+down', function () {\n\t\t\tvar activeContact = $('.chats-list .bg-primary');\n\t\t\tvar next = activeContact.next();\n\n\t\t\tif (next.length) {\n\t\t\t\tChats.switchChat(next.attr('data-roomid'));\n\t\t\t}\n\t\t});\n\t\tmousetrap.bind('up', function (e) {\n\t\t\tif (e.target === components.get('chat/input').get(0)) {\n\t\t\t\t// Retrieve message id from messages list\n\t\t\t\tvar message = components.get('chat/messages').find('.chat-message[data-self=\"1\"]').last();\n\t\t\t\tvar lastMid = message.attr('data-mid');\n\t\t\t\tvar inputEl = components.get('chat/input');\n\n\t\t\t\tmessages.prepEdit(inputEl, lastMid, ajaxify.data.roomId);\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addRenameHandler = function (roomId, inputEl) {\n\t\tvar oldName = inputEl.val();\n\t\tinputEl.on('blur keypress', function (ev) {\n\t\t\tif (ev.type === 'keypress' && ev.keyCode !== 13) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar newName = inputEl.val();\n\n\t\t\tif (oldName === newName) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('modules.chats.renameRoom', {\n\t\t\t\troomId: roomId,\n\t\t\t\tnewName: newName,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\toldName = newName;\n\t\t\t\tinputEl.blur();\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.addSendHandlers = function (roomId, inputEl, sendEl) {\n\t\tinputEl.off('keypress').on('keypress', function (e) {\n\t\t\tif (e.which === 13 && !e.shiftKey) {\n\t\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\tsendEl.off('click').on('click', function () {\n\t\t\tmessages.sendMessage(roomId, inputEl);\n\t\t\tinputEl.focus();\n\t\t\treturn false;\n\t\t});\n\t};\n\n\tChats.createAutoComplete = function (element) {\n\t\tvar data = {\n\t\t\telement: element,\n\t\t\tstrategies: [],\n\t\t\toptions: {\n\t\t\t\tzIndex: 20000,\n\t\t\t\tlistPosition: function (position) {\n\t\t\t\t\tthis.$el.css(this._applyPlacement(position));\n\t\t\t\t\tthis.$el.css('position', 'absolute');\n\t\t\t\t\treturn this;\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\t$(window).trigger('chat:autocomplete:init', data);\n\t\tif (data.strategies.length) {\n\t\t\tdata.element.textcomplete(data.strategies, data.options);\n\t\t}\n\t};\n\n\tChats.createTagsInput = function (tagEl, data) {\n\t\ttagEl.tagsinput({\n\t\t\tconfirmKeys: [13, 44],\n\t\t\ttrimValue: true,\n\t\t});\n\n\t\tif (data.users && data.users.length) {\n\t\t\tdata.users.forEach(function (user) {\n\t\t\t\ttagEl.tagsinput('add', $('<div/>').html(user.username).text());\n\t\t\t});\n\t\t}\n\n\t\ttagEl.on('beforeItemAdd', function (event) {\n\t\t\tevent.cancel = event.item === app.user.username;\n\t\t});\n\n\t\ttagEl.on('itemAdded', function (event) {\n\t\t\tif (event.item === app.user.username) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('modules.chats.addUserToRoom', {\n\t\t\t\troomId: data.roomId,\n\t\t\t\tusername: event.item,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\tapp.alertError(err.message);\n\t\t\t\t\ttagEl.tagsinput('remove', event.item, {\n\t\t\t\t\t\tnouser: true,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\ttagEl.on('beforeItemRemove', function (event) {\n\t\t\tif (event.options && event.options.nouser) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tevent.cancel = !data.isOwner || tagEl.tagsinput('items').length < 2;\n\t\t\tif (!data.owner) {\n\t\t\t\treturn app.alertError('[[error:not-allowed]]');\n\t\t\t}\n\n\t\t\tif (tagEl.tagsinput('items').length < 2) {\n\t\t\t\treturn app.alertError('[[error:cant-remove-last-user]]');\n\t\t\t}\n\t\t});\n\n\t\ttagEl.on('itemRemoved', function (event) {\n\t\t\tif (event.options && event.options.nouser) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tsocket.emit('modules.chats.removeUserFromRoom', {\n\t\t\t\troomId: data.roomId,\n\t\t\t\tusername: event.item,\n\t\t\t}, function (err) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\tvar input = $('.users-tag-container').find('.bootstrap-tagsinput input');\n\n\t\trequire(['autocomplete'], function (autocomplete) {\n\t\t\tautocomplete.user(input);\n\t\t});\n\t};\n\n\tChats.leave = function (el) {\n\t\tvar roomId = el.attr('data-roomid');\n\t\tsocket.emit('modules.chats.leave', roomId, function (err) {\n\t\t\tif (err) {\n\t\t\t\treturn app.alertError(err.message);\n\t\t\t}\n\t\t\tif (parseInt(roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tajaxify.go('user/' + ajaxify.data.userslug + '/chats');\n\t\t\t} else {\n\t\t\t\tel.remove();\n\t\t\t}\n\t\t\trequire(['chat'], function (chat) {\n\t\t\t\tvar modal = chat.getModal(roomId);\n\t\t\t\tif (modal.length) {\n\t\t\t\t\tchat.close(modal);\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t};\n\n\tChats.switchChat = function (roomid) {\n\t\tvar url = 'user/' + ajaxify.data.userslug + '/chats/' + roomid;\n\t\tif (self.fetch) {\n\t\t\tfetch(config.relative_path + '/api/' + url, { credentials: 'include' })\n\t\t\t\t.then(function (response) {\n\t\t\t\t\tif (response.ok) {\n\t\t\t\t\t\tresponse.json().then(function (payload) {\n\t\t\t\t\t\t\tapp.parseAndTranslate('partials/chats/message-window', payload, function (html) {\n\t\t\t\t\t\t\t\tcomponents.get('chat/main-wrapper').html(html);\n\t\t\t\t\t\t\t\tChats.resizeMainWindow();\n\t\t\t\t\t\t\t\tajaxify.data = payload;\n\t\t\t\t\t\t\t\tChats.setActive();\n\t\t\t\t\t\t\t\tChats.addEventListeners();\n\n\t\t\t\t\t\t\t\tif (history.pushState) {\n\t\t\t\t\t\t\t\t\thistory.pushState({\n\t\t\t\t\t\t\t\t\t\turl: 'user/' + payload.userslug + '/chats/' + payload.roomId,\n\t\t\t\t\t\t\t\t\t}, null, window.location.protocol + '//' + window.location.host + config.relative_path + '/user/' + payload.userslug + '/chats/' + payload.roomId);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.warn('[search] Received ' + response.status);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch(function (error) {\n\t\t\t\t\tconsole.warn('[search] ' + error.message);\n\t\t\t\t});\n\t\t} else {\n\t\t\tajaxify.go(url);\n\t\t}\n\t};\n\n\tChats.addGlobalEventListeners = function () {\n\t\t$(window).on('resize', Chats.resizeMainWindow);\n\t\t$(window).on('mousemove keypress click', function () {\n\t\t\tif (newMessage && ajaxify.data.roomId) {\n\t\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t\tnewMessage = false;\n\t\t\t}\n\t\t});\n\t};\n\n\tChats.addSocketListeners = function () {\n\t\tsocket.on('event:chats.receive', function (data) {\n\t\t\tif (parseInt(data.roomId, 10) === parseInt(ajaxify.data.roomId, 10)) {\n\t\t\t\tnewMessage = data.self === 0;\n\t\t\t\tdata.message.self = data.self;\n\n\t\t\t\tmessages.appendChatMessage($('.expanded-chat .chat-content'), data.message);\n\t\t\t} else if (ajaxify.currentPage.startsWith('chats')) {\n\t\t\t\tvar roomEl = $('[data-roomid=' + data.roomId + ']');\n\n\t\t\t\tif (roomEl.length > 0) {\n\t\t\t\t\troomEl.addClass('unread');\n\t\t\t\t} else {\n\t\t\t\t\tvar recentEl = components.get('chat/recent');\n\t\t\t\t\tBenchpress.parse('partials/chats/recent_room', {\n\t\t\t\t\t\trooms: {\n\t\t\t\t\t\t\troomId: data.roomId,\n\t\t\t\t\t\t\tlastUser: data.message.fromUser,\n\t\t\t\t\t\t\tusernames: data.message.fromUser.username,\n\t\t\t\t\t\t\tunread: true,\n\t\t\t\t\t\t},\n\t\t\t\t\t}, function (html) {\n\t\t\t\t\t\ttranslator.translate(html, function (translated) {\n\t\t\t\t\t\t\trecentEl.prepend(translated);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tsocket.on('event:user_status_change', function (data) {\n\t\t\tapp.updateUserStatus($('.chats-list [data-uid=\"' + data.uid + '\"] [component=\"user/status\"]'), data.status);\n\t\t});\n\n\t\tmessages.onChatMessageEdit();\n\n\t\tsocket.on('event:chats.roomRename', function (data) {\n\t\t\t$('[component=\"chat/room/name\"]').val($('<div/>').html(data.newName).text());\n\t\t});\n\t};\n\n\tChats.resizeMainWindow = function () {\n\t\tvar messagesList = $('.expanded-chat .chat-content');\n\t\tvar searchHeight = $('.chat-search').height();\n\t\tvar searchListHeight = $('[component=\"chat/search/list\"]').outerHeight(true) - $('[component=\"chat/search/list\"]').height();\n\t\tvar fromTop = components.get('chat/recent').offset().top;\n\n\t\tif (messagesList.length) {\n\t\t\tvar margin = $('.expanded-chat ul').outerHeight(true) - $('.expanded-chat ul').height();\n\t\t\tvar inputHeight = $('.chat-input').outerHeight(true);\n\n\t\t\tmessagesList.height($(window).height() - (fromTop + inputHeight + (margin * 4)));\n\t\t\tcomponents.get('chat/recent').height($('.expanded-chat').height() - (searchHeight + searchListHeight));\n\t\t\t$('[component=\"chat/search/list\"]').css('max-height', (components.get('chat/recent').height() / 2) + 'px');\n\t\t} else {\n\t\t\tcomponents.get('chat/recent').height($(window).height() - (fromTop + searchHeight + searchListHeight));\n\t\t}\n\n\t\tChats.setActive();\n\t};\n\n\tChats.setActive = function () {\n\t\tif (ajaxify.data.roomId) {\n\t\t\tsocket.emit('modules.chats.markRead', ajaxify.data.roomId);\n\t\t\t$('.expanded-chat input').focus();\n\t\t}\n\t\t$('.chats-list li').removeClass('bg-primary');\n\t\t$('.chats-list li[data-roomid=\"' + ajaxify.data.roomId + '\"]').addClass('bg-primary');\n\t};\n\n\n\treturn Chats;\n});\n"]}